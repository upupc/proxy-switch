#!/bin/bash
#
# proxy-switch - Proxy Configuration Manager for .bashrc and .npmrc
# Manage HTTP/HTTPS/SOCKS5 proxy configurations
#

set -e

# Configuration
PROXY_SWITCH_DIR="${HOME}/.proxy-switch"
PROFILES_FILE="${PROXY_SWITCH_DIR}/profiles"
BASHRC_FILE="${HOME}/.bashrc"
NPMRC_FILE="${HOME}/.npmrc"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

#-------------------------------------------------------------------------------
# Utility Functions
#-------------------------------------------------------------------------------

log_info() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

log_success() {
    echo -e "${GREEN}[OK]${NC} $1"
}

log_warn() {
    echo -e "${YELLOW}[WARN]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1" >&2
}

ensure_dir() {
    if [[ ! -d "$PROXY_SWITCH_DIR" ]]; then
        mkdir -p "$PROXY_SWITCH_DIR"
    fi
    if [[ ! -f "$PROFILES_FILE" ]]; then
        touch "$PROFILES_FILE"
    fi
}

#-------------------------------------------------------------------------------
# Profile Management Functions
#-------------------------------------------------------------------------------

save_profile() {
    local name="$1"
    local http_proxy="$2"
    local https_proxy="$3"
    local socks_proxy="$4"
    local no_proxy="$5"

    ensure_dir

    # Remove existing profile with same name
    sed -i "/^# \[proxy-switch: ${name}\]$/,/^# \[end-proxy-switch: ${name}\]$/d" "$PROFILES_FILE" 2>/dev/null || true

    # Add new profile
    cat >> "$PROFILES_FILE" << EOF
# [proxy-switch: ${name}]
# proxy-http=${http_proxy}
# proxy-https=${https_proxy}
# proxy-socks=${socks_proxy}
# proxy-no_proxy=${no_proxy}
# [end-proxy-switch: ${name}]
EOF

    log_success "Profile '${name}' saved successfully"
}

load_profile() {
    local name="$1"
    local http_proxy https_proxy socks_proxy no_proxy

    if [[ ! -f "$PROFILES_FILE" ]]; then
        log_error "No profiles found. Please create a profile first."
        return 1
    fi

    # Parse profile from file
    http_proxy=$(sed -n "/^# \[proxy-switch: ${name}\]$/,/^# \[end-proxy-switch: ${name}\]$/p" "$PROFILES_FILE" | grep "^# proxy-http=" | cut -d'=' -f2-)
    https_proxy=$(sed -n "/^# \[proxy-switch: ${name}\]$/,/^# \[end-proxy-switch: ${name}\]$/p" "$PROFILES_FILE" | grep "^# proxy-https=" | cut -d'=' -f2-)
    socks_proxy=$(sed -n "/^# \[proxy-switch: ${name}\]$/,/^# \[end-proxy-switch: ${name}\]$/p" "$PROFILES_FILE" | grep "^# proxy-socks=" | cut -d'=' -f2-)
    no_proxy=$(sed -n "/^# \[proxy-switch: ${name}\]$/,/^# \[end-proxy-switch: ${name}\]$/p" "$PROFILES_FILE" | grep "^# proxy-no_proxy=" | cut -d'=' -f2-)

    if [[ -z "$http_proxy" && -z "$https_proxy" ]]; then
        log_error "Profile '${name}' not found"
        return 1
    fi

    echo "$http_proxy|$https_proxy|$socks_proxy|$no_proxy"
}

delete_profile() {
    local name="$1"

    if [[ ! -f "$PROFILES_FILE" ]]; then
        log_error "No profiles found"
        return 1
    fi

    sed -i "/^# \[proxy-switch: ${name}\]$/,/^# \[end-proxy-switch: ${name}\]$/d" "$PROFILES_FILE"
    log_success "Profile '${name}' deleted"
}

list_profiles() {
    ensure_dir

    echo -e "${BLUE}Available Profiles:${NC}"
    echo "--------------------"

    local count=0
    while IFS= read -r line; do
        case "$line" in
            "# [proxy-switch: "*)
                name="${line#\# \[proxy-switch: }"
                name="${name%]}"
                echo -e "  ${GREEN}*${NC} $name"
                count=$((count + 1))
                ;;
        esac
    done < "$PROFILES_FILE"

    if [[ $count -eq 0 ]]; then
        log_warn "No profiles found. Use 'proxy-switch add' to create one."
    fi
}

get_all_profile_names() {
    ensure_dir
    grep "^# \[proxy-switch:" "$PROFILES_FILE" | sed 's/# \[proxy-switch: //' | sed 's/\]//'
}

#-------------------------------------------------------------------------------
# .bashrc Manipulation Functions
#-------------------------------------------------------------------------------

remove_proxy_from_bashrc() {
    # Remove proxy-switch managed lines from .bashrc
    sed -i '/# \[proxy-switch-managed\]/,/^$/d' "$BASHRC_FILE" 2>/dev/null || true
}

apply_proxy_to_bashrc() {
    local http_proxy="$1"
    local https_proxy="$2"
    local socks_proxy="$3"
    local no_proxy="$4"

    # Remove existing proxy-switch managed lines
    remove_proxy_from_bashrc

    # Append new configuration
    cat >> "$BASHRC_FILE" << EOF

# [proxy-switch-managed]
# Proxy configuration - DO NOT EDIT MANUALLY
export http_proxy="${http_proxy}"
export HTTP_PROXY="${http_proxy}"
export https_proxy="${https_proxy}"
export HTTPS_PROXY="${https_proxy}"
export socks_proxy="${socks_proxy}"
export SOCKS_PROXY="${socks_proxy}"
export no_proxy="${no_proxy}"
export NO_PROXY="${no_proxy}"
# [end-proxy-switch-managed]
EOF

    log_success "Proxy configuration applied to ${BASHRC_FILE}"
}

disable_proxy() {
    remove_proxy_from_bashrc
    log_success "Proxy configuration disabled (removed from .bashrc)"
    log_info "Run 'source ~/.bashrc' or open a new terminal to apply changes"
}

show_current_config() {
    echo -e "${BLUE}Current Active Proxy Configuration:${NC}"
    echo "-----------------------------------"

    if grep -q "# \[proxy-switch-managed\]" "$BASHRC_FILE" 2>/dev/null; then
        grep -A 10 "# \[proxy-switch-managed\]" "$BASHRC_FILE" 2>/dev/null | head -9
    else
        log_warn "No active proxy configuration found in .bashrc"
    fi

    echo ""
    echo -e "${BLUE}.npmrc Configuration:${NC}"
    echo "----------------------"
    if [[ -f "$NPMRC_FILE" ]] && grep -q "proxy-switch" "$NPMRC_FILE" 2>/dev/null; then
        grep "proxy-switch" "$NPMRC_FILE" 2>/dev/null || log_warn "No npmrc proxy configuration"
    else
        log_warn "No active npmrc proxy configuration"
    fi

    echo ""
    log_info "Use 'proxy-switch use <name>' to enable a profile"
}

#-------------------------------------------------------------------------------
# .npmrc Manipulation Functions
#-------------------------------------------------------------------------------

remove_proxy_from_npmrc() {
    # Remove proxy-switch managed lines from .npmrc
    if [[ -f "$NPMRC_FILE" ]]; then
        sed -i '/# \[proxy-switch-npmrc\]/,/^$/d' "$NPMRC_FILE" 2>/dev/null || true
    fi
}

apply_proxy_to_npmrc() {
    local http_proxy="$1"
    local https_proxy="$2"

    # Create .npmrc if it doesn't exist
    touch "$NPMRC_FILE"

    # Remove existing proxy-switch managed lines
    remove_proxy_from_npmrc

    # Append new configuration
    cat >> "$NPMRC_FILE" << EOF

# [proxy-switch-npmrc]
# Proxy configuration - DO NOT EDIT MANUALLY
proxy=${http_proxy}
https-proxy=${https_proxy}
# [end-proxy-switch-npmrc]
EOF

    log_success "Proxy configuration applied to ${NPMRC_FILE}"
}

disable_npmrc_proxy() {
    remove_proxy_from_npmrc
    log_success "NPM proxy configuration removed from ${NPMRC_FILE}"
}

show_npmrc_config() {
    echo -e "${BLUE}.npmrc Proxy Configuration:${NC}"
    echo "----------------------------"

    if [[ -f "$NPMRC_FILE" ]] && grep -q "# \[proxy-switch-npmrc\]" "$NPMRC_FILE" 2>/dev/null; then
        grep -A 6 "# \[proxy-switch-npmrc\]" "$NPMRC_FILE" 2>/dev/null | head -5
    else
        log_warn "No active npmrc proxy configuration"
        log_info "Use 'proxy-switch npmrc <name>' to enable npm proxy"
    fi
}

#-------------------------------------------------------------------------------
# Interactive Mode
#-------------------------------------------------------------------------------

interactive_menu() {
    local choice

    while true; do
        echo ""
        echo -e "${BLUE}╔══════════════════════════════════════╗${NC}"
        echo -e "${BLUE}║       Proxy Switch - Main Menu       ║${NC}"
        echo -e "${BLUE}╠══════════════════════════════════════╣${NC}"
        echo -e "${BLUE}║  1) List all profiles                ║${NC}"
        echo -e "${BLUE}║  2) Add new profile                  ║${NC}"
        echo -e "${BLUE}║  3) Enable a profile                 ║${NC}"
        echo -e "${BLUE}║  4) Delete a profile                 ║${NC}"
        echo -e "${BLUE}║  5) Show current configuration       ║${NC}"
        echo -e "${BLUE}║  6) Disable proxy                    ║${NC}"
        echo -e "${BLUE}║  0) Exit                             ║${NC}"
        echo -e "${BLUE}╚══════════════════════════════════════╝${NC}"
        echo ""
        read -p "Enter your choice [0-6]: " choice
        echo ""

        case "$choice" in
            0)
                echo "Goodbye!"
                break
                ;;
            1)
                list_profiles
                ;;
            2)
                interactive_add_profile
                ;;
            3)
                interactive_use_profile
                ;;
            4)
                interactive_delete_profile
                ;;
            5)
                show_current_config
                ;;
            6)
                disable_proxy
                ;;
            *)
                log_error "Invalid choice. Please try again."
                ;;
        esac

        if [[ "$choice" != "0" ]]; then
            echo ""
            read -p "Press Enter to continue..."
        fi
    done
}

interactive_add_profile() {
    local name http https socks no_proxy

    read -p "Profile name: " name
    [[ -z "$name" ]] && { log_error "Name cannot be empty"; return; }

    read -p "HTTP proxy [http://host:port]: " http
    read -p "HTTPS proxy [http://host:port]: " https
    read -p "SOCKS proxy [socks://host:port]: " socks
    read -p "No proxy (comma-separated): " no_proxy

    save_profile "$name" "$http" "$https" "$socks" "$no_proxy"
}

interactive_use_profile() {
    local name selected

    list_profiles
    echo ""
    PS3="Select a profile to enable (number): "
    select selected in $(get_all_profile_names) "Cancel"; do
        if [[ "$selected" == "Cancel" || -z "$selected" ]]; then
            echo "Cancelled"
            break
        fi
        use_profile "$selected"
        break
    done
}

interactive_delete_profile() {
    local name selected

    list_profiles
    echo ""
    PS3="Select a profile to delete (number): "
    select selected in $(get_all_profile_names) "Cancel"; do
        if [[ "$selected" == "Cancel" || -z "$selected" ]]; then
            echo "Cancelled"
            break
        fi
        read -p "Delete profile '${selected}'? [y/N]: " confirm
        if [[ "$confirm" =~ ^[Yy]$ ]]; then
            delete_profile "$selected"
        else
            echo "Cancelled"
        fi
        break
    done
}

#-------------------------------------------------------------------------------
# Command Handlers
#-------------------------------------------------------------------------------

cmd_add() {
    local name="$1"
    local http="$2"
    local https="$3"
    local socks="$4"
    local no_proxy="${5:-localhost,127.0.0.1}"

    if [[ -z "$name" || -z "$http" ]]; then
        log_error "Usage: proxy-switch add <name> <http-proxy> [https-proxy] [socks-proxy] [no_proxy]"
        exit 1
    fi

    save_profile "$name" "$http" "$https" "$socks" "$no_proxy"
}

cmd_use() {
    local name="$1"
    local npmrc_only=false

    # Parse options
    while [[ $# -gt 0 ]]; do
        case "$1" in
            --npmrc)
                npmrc_only=true
                shift
                ;;
            *)
                shift
                ;;
        esac
    done

    if [[ -z "$name" ]]; then
        log_error "Usage: proxy-switch use <name> [--npmrc]"
        exit 1
    fi

    local result
    result=$(load_profile "$name") || exit 1

    local http_proxy https_proxy socks_proxy no_proxy
    http_proxy=$(echo "$result" | cut -d'|' -f1)
    https_proxy=$(echo "$result" | cut -d'|' -f2)
    socks_proxy=$(echo "$result" | cut -d'|' -f3)
    no_proxy=$(echo "$result" | cut -d'|' -f4)

    if [[ "$npmrc_only" == "true" ]]; then
        apply_proxy_to_npmrc "$http_proxy" "$https_proxy"
        log_success "Profile '${name}' applied to .npmrc"
    else
        apply_proxy_to_bashrc "$http_proxy" "$https_proxy" "$socks_proxy" "$no_proxy"
        apply_proxy_to_npmrc "$http_proxy" "$https_proxy"
        log_success "Profile '${name}' is now active"
        log_info "Run 'source ~/.bashrc' to apply changes"
    fi
}

cmd_npmrc() {
    local name="$1"

    if [[ -z "$name" ]]; then
        log_error "Usage: proxy-switch npmrc <name>"
        exit 1
    fi

    local result
    result=$(load_profile "$name") || exit 1

    local http_proxy https_proxy
    http_proxy=$(echo "$result" | cut -d'|' -f1)
    https_proxy=$(echo "$result" | cut -d'|' -f2)

    apply_proxy_to_npmrc "$http_proxy" "$https_proxy"
    log_success "Profile '${name}' applied to .npmrc"
}

cmd_list() {
    list_profiles
}

cmd_delete() {
    local name="$1"

    if [[ -z "$name" ]]; then
        log_error "Usage: proxy-switch delete <name>"
        exit 1
    fi

    delete_profile "$name"
}

cmd_disable() {
    local npmrc_only=false

    while [[ $# -gt 0 ]]; do
        case "$1" in
            --npmrc)
                npmrc_only=true
                shift
                ;;
            *)
                shift
                ;;
        esac
    done

    if [[ "$npmrc_only" == "true" ]]; then
        disable_npmrc_proxy
    else
        disable_proxy
        disable_npmrc_proxy
        log_success "All proxy configurations disabled"
    fi
}

cmd_npmrc_disable() {
    disable_npmrc_proxy
}

cmd_status() {
    show_current_config
}

cmd_npmrc_status() {
    show_npmrc_config
}

#-------------------------------------------------------------------------------
# no_proxy Management Functions
#-------------------------------------------------------------------------------

get_no_proxy_from_bashrc() {
    grep "^export no_proxy=" "$BASHRC_FILE" 2>/dev/null | cut -d'"' -f2 || echo ""
}

get_no_proxy_from_env() {
    echo "${no_proxy:-}"
}

cmd_no_proxy_list() {
    echo -e "${BLUE}Current no_proxy Configuration:${NC}"
    echo "-----------------------------------"

    local bashrc_no_proxy
    bashrc_no_proxy=$(get_no_proxy_from_bashrc)

    if [[ -n "$bashrc_no_proxy" ]]; then
        echo -e "${GREEN}.bashrc:${NC}"
        echo "  $bashrc_no_proxy"
    else
        echo -e "${YELLOW}.bashrc:${NC} (not set)"
    fi

    local env_no_proxy
    env_no_proxy=$(get_no_proxy_from_env)
    if [[ -n "$env_no_proxy" ]]; then
        echo -e "${GREEN}Environment:${NC}"
        echo "  $env_no_proxy"
    fi
}

cmd_no_proxy_add() {
    if [[ $# -eq 0 ]]; then
        log_error "Usage: proxy-switch no-proxy add <domain> [domain...]"
        exit 1
    fi

    local domains="$*"
    local current_no_proxy
    current_no_proxy=$(get_no_proxy_from_bashrc)

    # Add domains if not already in list
    local new_domains=""
    for domain in "$@"; do
        if [[ "$current_no_proxy" != *"$domain"* ]]; then
            new_domains="${new_domains}${domain},"
        fi
    done

    if [[ -z "$new_domains" ]]; then
        log_warn "All domains already in no_proxy list"
        return
    fi

    # Remove trailing comma and combine
    new_domains="${new_domains%,}"
    local combined="${current_no_proxy}${current_no_proxy:+,}${new_domains}"

    # Update bashrc
    remove_proxy_from_bashrc
    local http_proxy https_proxy socks_proxy
    http_proxy=$(grep "^export http_proxy=" "$BASHRC_FILE" 2>/dev/null | cut -d'"' -f2 || echo "")
    https_proxy=$(grep "^export https_proxy=" "$BASHRC_FILE" 2>/dev/null | cut -d'"' -f2 || echo "")
    socks_proxy=$(grep "^export socks_proxy=" "$BASHRC_FILE" 2>/dev/null | cut -d'"' -f2 || echo "")

    if [[ -n "$http_proxy" || -n "$https_proxy" || -n "$socks_proxy" ]]; then
        cat >> "$BASHRC_FILE" << EOF

# [proxy-switch-managed]
# Proxy configuration - DO NOT EDIT MANUALLY
export http_proxy="${http_proxy}"
export HTTP_PROXY="${http_proxy}"
export https_proxy="${https_proxy}"
export HTTPS_PROXY="${https_proxy}"
export socks_proxy="${socks_proxy}"
export SOCKS_PROXY="${socks_proxy}"
export no_proxy="${combined}"
export NO_PROXY="${combined}"
# [end-proxy-switch-managed]
EOF
        log_success "Added to no_proxy: $new_domains"
        log_info "Run 'source ~/.bashrc' to apply changes"
    else
        log_error "No active proxy configuration found in .bashrc"
        log_info "Use 'proxy-switch use <name>' first, then add no_proxy domains"
    fi
}

cmd_no_proxy_remove() {
    if [[ $# -eq 0 ]]; then
        log_error "Usage: proxy-switch no-proxy remove <domain> [domain...]"
        exit 1
    fi

    local current_no_proxy
    current_no_proxy=$(get_no_proxy_from_bashrc)

    if [[ -z "$current_no_proxy" ]]; then
        log_error "no_proxy is not set in .bashrc"
        exit 1
    fi

    local remaining="$current_no_proxy"
    for domain in "$@"; do
        # Remove domain from list (handles comma-separated values)
        remaining=$(echo "$remaining" | sed "s/,${domain}//g" | sed "s/${domain},//g" | sed "s/${domain}//g")
    done

    # Update bashrc
    remove_proxy_from_bashrc
    local http_proxy https_proxy socks_proxy
    http_proxy=$(grep "^export http_proxy=" "$BASHRC_FILE" 2>/dev/null | cut -d'"' -f2 || echo "")
    https_proxy=$(grep "^export https_proxy=" "$BASHRC_FILE" 2>/dev/null | cut -d'"' -f2 || echo "")
    socks_proxy=$(grep "^export socks_proxy=" "$BASHRC_FILE" 2>/dev/null | cut -d'"' -f2 || echo "")

    if [[ -n "$http_proxy" || -n "$https_proxy" || -n "$socks_proxy" ]]; then
        cat >> "$BASHRC_FILE" << EOF

# [proxy-switch-managed]
# Proxy configuration - DO NOT EDIT MANUALLY
export http_proxy="${http_proxy}"
export HTTP_PROXY="${http_proxy}"
export https_proxy="${https_proxy}"
export HTTPS_PROXY="${https_proxy}"
export socks_proxy="${socks_proxy}"
export SOCKS_PROXY="${socks_proxy}"
export no_proxy="${remaining}"
export NO_PROXY="${remaining}"
# [end-proxy-switch-managed]
EOF
        log_success "Removed from no_proxy: $*"
        log_info "Run 'source ~/.bashrc' to apply changes"
    fi
}

cmd_no_proxy_clear() {
    local current_no_proxy
    current_no_proxy=$(get_no_proxy_from_bashrc)

    if [[ -z "$current_no_proxy" ]]; then
        log_warn "no_proxy is already empty"
        return
    fi

    # Update bashrc
    remove_proxy_from_bashrc
    local http_proxy https_proxy socks_proxy
    http_proxy=$(grep "^export http_proxy=" "$BASHRC_FILE" 2>/dev/null | cut -d'"' -f2 || echo "")
    https_proxy=$(grep "^export https_proxy=" "$BASHRC_FILE" 2>/dev/null | cut -d'"' -f2 || echo "")
    socks_proxy=$(grep "^export socks_proxy=" "$BASHRC_FILE" 2>/dev/null | cut -d'"' -f2 || echo "")

    if [[ -n "$http_proxy" || -n "$https_proxy" || -n "$socks_proxy" ]]; then
        cat >> "$BASHRC_FILE" << EOF

# [proxy-switch-managed]
# Proxy configuration - DO NOT EDIT MANUALLY
export http_proxy="${http_proxy}"
export HTTP_PROXY="${http_proxy}"
export https_proxy="${https_proxy}"
export HTTPS_PROXY="${https_proxy}"
export socks_proxy="${socks_proxy}"
export SOCKS_PROXY="${socks_proxy}"
export no_proxy=""
export NO_PROXY=""
# [end-proxy-switch-managed]
EOF
        log_success "Cleared no_proxy configuration"
        log_info "Run 'source ~/.bashrc' to apply changes"
    fi
}

cmd_help() {
    cat << EOF
proxy-switch - Proxy Configuration Manager for .bashrc and .npmrc

Usage: proxy-switch <command> [arguments]

Commands:
    add <name> <http> [https] [socks] [no_proxy]
        Add a new proxy profile

    use <name> [--npmrc]
        Enable a profile for bashrc (default) or npmrc only

    npmrc <name>
        Enable a profile for .npmrc only

    list
        List all available profiles

    delete <name>
        Delete a proxy profile

    disable [--npmrc]
        Disable all proxy configurations

    npmrc-disable
        Disable .npmrc proxy only

    status
        Show current active configuration

    npmrc-status
        Show .npmrc proxy configuration

    interactive, -i
        Enter interactive menu mode

    no-proxy list
        Show current no_proxy configuration

    no-proxy add <domain> [domain...]
        Add domains to no_proxy list

    no-proxy remove <domain> [domain...]
        Remove domains from no_proxy list

    no-proxy clear
        Clear all no_proxy entries

    help
        Show this help message

Examples:
    proxy-switch add work http://proxy.company.com:8080
    proxy-switch add home http://192.168.1.1:8080 socks5://192.168.1.1:1080
    proxy-switch use work              # Enable for bashrc and npmrc
    proxy-switch use work --npmrc      # Enable for npmrc only
    proxy-switch npmrc work            # Enable for npmrc only
    proxy-switch disable               # Disable all
    proxy-switch disable --npmrc       # Disable npmrc only

For more information, visit: https://github.com/example/proxy-switch
EOF
}

#-------------------------------------------------------------------------------
# Main Entry Point
#-------------------------------------------------------------------------------

main() {
    ensure_dir

    if [[ $# -eq 0 ]]; then
        cmd_help
        exit 0
    fi

    local command="$1"
    shift

    case "$command" in
        add|set)
            cmd_add "$@"
            ;;
        use|enable|switch)
            cmd_use "$@"
            ;;
        npmrc)
            cmd_npmrc "$@"
            ;;
        list|ls)
            cmd_list
            ;;
        delete|remove|rm)
            cmd_delete "$@"
            ;;
        disable|off)
            cmd_disable "$@"
            ;;
        npmrc-disable)
            cmd_npmrc_disable
            ;;
        status|show)
            cmd_status
            ;;
        npmrc-status)
            cmd_npmrc_status
            ;;
        interactive|-i)
            interactive_menu
            ;;
        no-proxy)
            local no_proxy_cmd="$1"
            shift
            case "$no_proxy_cmd" in
                list)
                    cmd_no_proxy_list
                    ;;
                add)
                    cmd_no_proxy_add "$@"
                    ;;
                remove)
                    cmd_no_proxy_remove "$@"
                    ;;
                clear)
                    cmd_no_proxy_clear
                    ;;
                *)
                    log_error "Unknown no-proxy command: $no_proxy_cmd"
                    echo "Usage: proxy-switch no-proxy {list|add|remove|clear}"
                    exit 1
                    ;;
            esac
            ;;
        help|--help|-h)
            cmd_help
            ;;
        *)
            log_error "Unknown command: $command"
            echo "Run 'proxy-switch help' for usage information"
            exit 1
            ;;
    esac
}

main "$@"
